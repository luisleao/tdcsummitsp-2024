{
  "description": "A New Flow",
  "states": [
    {
      "name": "Trigger",
      "type": "trigger",
      "transitions": [
        {
          "next": "tem_imagem",
          "event": "incomingMessage"
        },
        {
          "event": "incomingCall"
        },
        {
          "event": "incomingConversationMessage"
        },
        {
          "event": "incomingRequest"
        },
        {
          "event": "incomingParent"
        }
      ],
      "properties": {
        "offset": {
          "x": 220,
          "y": -380
        }
      }
    },
    {
      "name": "tem_imagem",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "tem_geo",
          "event": "noMatch"
        },
        {
          "next": "RetornoMensagemComImagem",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "IMAGEM",
              "arguments": [
                "{{trigger.message.MediaContentType0}}"
              ],
              "type": "matches_any_of",
              "value": "image/jpeg"
            }
          ]
        },
        {
          "next": "Invalido",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "INVALIDO",
              "arguments": [
                "{{trigger.message.MediaContentType0}}"
              ],
              "type": "matches_any_of",
              "value": "video/mp4,audio/aac, audio/mp4, audio/mpeg, audio/amr, audio/ogg"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{trigger.message.MediaContentType0}}",
        "offset": {
          "x": -40,
          "y": -160
        }
      }
    },
    {
      "name": "RetornoMensagemComImagem",
      "type": "send-message",
      "transitions": [
        {
          "next": "identificaLixo",
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 300,
          "y": 260
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "message_type": "custom",
        "to": "{{contact.channel.address}}",
        "body": "Recebi uma imagem!\n\nSÃ³ um momento que vamos tentar identificÃ¡-la..."
      }
    },
    {
      "name": "Invalido",
      "type": "send-message",
      "transitions": [
        {
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 910,
          "y": 140
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "message_type": "custom",
        "to": "{{contact.channel.address}}",
        "body": "No momento ainda nÃ£o conseguimos identificar resÃ­duos atravÃ©s de arquivos de vÃ­deo ou Ã¡udio.\n\nMas vocÃª pode mandar uma foto pra gente!"
      }
    },
    {
      "name": "IdentificarLixoREST",
      "type": "make-http-request",
      "transitions": [
        {
          "event": "success"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 940,
          "y": 530
        },
        "method": "POST",
        "content_type": "application/x-www-form-urlencoded;charset=utf-8",
        "body": "",
        "parameters": [
          {
            "value": "{{trigger.message.MediaUrl0}}",
            "key": "url"
          },
          {
            "value": "{{trigger.message.To}}",
            "key": "from"
          },
          {
            "value": "{{trigger.message.From}}",
            "key": "to"
          },
          {
            "value": "{{trigger.message.MessagingServiceSid}}",
            "key": "messagingServiceSid"
          },
          {
            "value": "{{trigger.message.ProfileName}}",
            "key": "profileName"
          }
        ],
        "url": "https://identificalixo-akbmy6t33q-uc.a.run.app"
      }
    },
    {
      "name": "tem_geo",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "onboarding",
          "event": "noMatch"
        },
        {
          "next": "aviso_timer_ecoponto_geral",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "GEO",
              "arguments": [
                "{{trigger.message.Latitude}}"
              ],
              "type": "is_not_blank",
              "value": "Is Not Blank"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{trigger.message.Latitude}}",
        "offset": {
          "x": -830,
          "y": -90
        }
      }
    },
    {
      "name": "retorno_ecoponto",
      "type": "send-message",
      "transitions": [
        {
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1030,
          "y": 810
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "message_type": "custom",
        "to": "{{contact.channel.address}}",
        "body": "{{widgets.ListaEcoPontos.parsed.mensagem}}"
      }
    },
    {
      "name": "fail_ecoponto",
      "type": "send-message",
      "transitions": [
        {
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -660,
          "y": 800
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "message_type": "custom",
        "to": "{{contact.channel.address}}",
        "body": "Infelizmente ocorreu um erro ao buscar pelo local de coleta mais prÃ³ximo de vocÃª.\n\nTente novamente mais tarde."
      }
    },
    {
      "name": "split_2",
      "type": "split-based-on",
      "transitions": [
        {
          "event": "noMatch"
        },
        {
          "next": "send_message_1",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "TEM LOCATION",
              "arguments": [
                "{{widgets.ListaEcoPontoREST.parsed.location}}"
              ],
              "type": "is_not_blank",
              "value": "Is Not Blank"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.ListaEcoPontoREST.parsed.location}}",
        "offset": {
          "x": -1840,
          "y": 2930
        }
      }
    },
    {
      "name": "send_message_1",
      "type": "send-message",
      "transitions": [
        {
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1260,
          "y": 2930
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "attributes": "{\npersistentAction: ['geo:37.787890,-122.391664|375 Beale St']\n}",
        "message_type": "custom",
        "to": "{{contact.channel.address}}",
        "body": "Aqui estÃ¡ a localizaÃ§Ã£o no mapa."
      }
    },
    {
      "name": "Copy_of_boas_vindas",
      "type": "send-message",
      "transitions": [
        {
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -2910,
          "y": 2110
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "message_type": "custom",
        "to": "{{contact.channel.address}}",
        "body": "ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨\nTODO: chamada de localizaÃ§Ã£o\nðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨"
      }
    },
    {
      "name": "aviso_timer_ecoponto_geral",
      "type": "send-message",
      "transitions": [
        {
          "next": "ListaEcoPontos",
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -900,
          "y": 280
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "message_type": "custom",
        "to": "{{contact.channel.address}}",
        "body": "SÃ³ um momento que estou buscando na base de dados de ecopontos o local de descarte mais prÃ³ximo."
      }
    },
    {
      "name": "gerarDicaRandomica",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "retorno_gerarDicaRandomica",
          "event": "success"
        },
        {
          "next": "erro_gerarDicaRandomica",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -3330,
          "y": 760
        },
        "method": "POST",
        "content_type": "application/x-www-form-urlencoded;charset=utf-8",
        "body": "",
        "parameters": [
          {
            "value": "{{flow.variables.ecoponto}}",
            "key": "filtro"
          }
        ],
        "url": "https://gerardicarandomica-akbmy6t33q-uc.a.run.app"
      }
    },
    {
      "name": "retorno_gerarDicaRandomica",
      "type": "send-message",
      "transitions": [
        {
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -3500,
          "y": 1040
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "message_type": "custom",
        "to": "{{contact.channel.address}}",
        "body": "{{widgets.gerarDicaRandomica.parsed.mensagem}}"
      }
    },
    {
      "name": "erro_gerarDicaRandomica",
      "type": "send-message",
      "transitions": [
        {
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -3150,
          "y": 1030
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "message_type": "custom",
        "to": "{{contact.channel.address}}",
        "body": "Dica de Ouro!\n\n*NÃ£o sabe qual o destino do que quer descartar?*\n\nEnvie a foto do item aqui e vamos tentar classificar o que Ã© e qual a melhor destinaÃ§Ã£o dele."
      }
    },
    {
      "name": "identificaLixo",
      "type": "run-function",
      "transitions": [
        {
          "next": "verifica_retorno_mensagem_function",
          "event": "success"
        },
        {
          "next": "fallback_erro",
          "event": "fail"
        }
      ],
      "properties": {
        "service_sid": "ZScb02297cbd4ee320977f59a4b176a7c1",
        "environment_sid": "ZE771a5460149ae7670bc5d5e01788dc28",
        "offset": {
          "x": 340,
          "y": 520
        },
        "function_sid": "ZH5f7ec56b5c97326cb959ba6c4077bc53",
        "parameters": [
          {
            "value": "{{trigger.message.MediaUrl0}}",
            "key": "url"
          },
          {
            "value": "{{trigger.message.To}}",
            "key": "from"
          },
          {
            "value": "{{trigger.message.From}}",
            "key": "to"
          }
        ],
        "url": "https://tdcsummitsp-solved-1804.twil.io/identificaLixo"
      }
    },
    {
      "name": "resultadoOpenAI",
      "type": "send-message",
      "transitions": [
        {
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 430,
          "y": 1000
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "message_type": "custom",
        "to": "{{contact.channel.address}}",
        "body": "{{widgets.identificaLixo.parsed.mensagem}}"
      }
    },
    {
      "name": "verifica_retorno_mensagem_function",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "retorno_padrao",
          "event": "noMatch"
        },
        {
          "next": "resultadoOpenAI",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "TEM MENSAGEM",
              "arguments": [
                "{{widgets.identificaLixo.parsed.mensagem}}"
              ],
              "type": "is_not_blank",
              "value": "Is Not Blank"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.identificaLixo.parsed.mensagem}}",
        "offset": {
          "x": 160,
          "y": 770
        }
      }
    },
    {
      "name": "retorno_padrao",
      "type": "send-message",
      "transitions": [
        {
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 90,
          "y": 1000
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "message_type": "custom",
        "to": "{{contact.channel.address}}",
        "body": "Eu encontrei na imagem *{{widgets.identificaLixo.parsed.obj}}*!\n\nO principal material dele Ã© *{{widgets.identificaLixo.parsed.mat}}*.\n\nPara descartÃ¡-lo:\n{{widgets.identificaLixo.parsed.descarte}}"
      }
    },
    {
      "name": "fallback_erro",
      "type": "send-message",
      "transitions": [
        {
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 650,
          "y": 770
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "message_type": "custom",
        "to": "{{contact.channel.address}}",
        "body": "NÃ£o foi possÃ­vel executar a consulta neste momento.\n\nTente novamente mais tarde por favor."
      }
    },
    {
      "name": "onboarding",
      "type": "send-message",
      "transitions": [
        {
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1530,
          "y": 50
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "message_type": "custom",
        "to": "{{contact.channel.address}}",
        "body": "Boas-vindas!"
      }
    },
    {
      "name": "ListaEcoPontos",
      "type": "run-function",
      "transitions": [
        {
          "next": "retorno_ecoponto",
          "event": "success"
        },
        {
          "next": "fail_ecoponto",
          "event": "fail"
        }
      ],
      "properties": {
        "service_sid": "ZScb02297cbd4ee320977f59a4b176a7c1",
        "environment_sid": "ZE771a5460149ae7670bc5d5e01788dc28",
        "offset": {
          "x": -760,
          "y": 570
        },
        "function_sid": "ZHbb24a5ae8d0d003526e15faf7020c527",
        "parameters": [
          {
            "value": "{{trigger.message.Latitude}}",
            "key": "lat"
          },
          {
            "value": "{{trigger.message.Longitude}}",
            "key": "lng"
          }
        ],
        "url": "https://tdcsummitsp-solved-1804.twil.io/listaEcopontos"
      }
    }
  ],
  "initial_state": "Trigger",
  "flags": {
    "allow_concurrent_calls": true
  }
}